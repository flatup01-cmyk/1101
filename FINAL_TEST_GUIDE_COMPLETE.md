# 🎯 最終テスト手順書

## ✅ デプロイ完了

**デプロイ日時:** 2025-11-08  
**更新関数:** `lineWebhookRouter`  
**Function URL:** `https://linewebhookrouter-kvuv4ufotq-an.a.run.app`

---

## 🔧 実装された修正

### 1. 動画保存パスの修正
- **変更前:** `videos/${userId}/${messageId}.mp4`
- **変更後:** `${userId}/${messageId}.mp4`
- **理由:** Dify APIのルールに合わせて、`videos/`接頭辞を削除

### 2. 署名付きURLの生成
- **変更前:** 公開アクセス不可のURL
- **変更後:** 署名付きURL（有効期限: 1時間）
- **理由:** Dify APIが動画ファイルにアクセスできるようにする

### 3. 詳細デバッグログの追加
- Dify APIリクエストの詳細をログ出力
- Dify APIエラーの詳細をログ出力
- トラブルシューティングを容易にする

---

## 🧪 テスト手順

### ステップ1: テスト動画の準備

**推奨仕様:**
- 形式: mp4
- 長さ: 5-10秒
- サイズ: < 50MB

### ステップ2: LINEボットに動画を送信

1. LINEアプリを開く
2. FLATUPGYMとのトーク画面に移動
3. テスト動画を送信

### ステップ3: 即時確認（証①）

**期待される動作:**
- 送信直後（数秒以内）に以下のメッセージが届く：
```
動画を受け付けました！AIが解析を開始します。

結果が届くまで、しばらくお待ちください…

※解析は20秒以内/100MB以下の動画が対象です。
```

**確認ポイント:**
- ✅ replyTokenの有効期限内に返信されているか
- ✅ メッセージが正しく表示されているか

### ステップ4: ログ確認（証②）

**リアルタイム監視（推奨）:**
```bash
./watch_logs.sh
```

**または、一度だけ確認:**
```bash
./check_dify_logs.sh
```

**期待されるログ:**
- `動画をCloud Storageに保存しました: ${userId}/${messageId}.mp4`
- `署名付きURLを生成しました: ...`
- `Dify APIリクエスト: {"url":"...","videoUrl":"...","userId":"..."}`
- `processVideoJob開始: jobId=..., lineUserId=..., videoUrl=...`
- `processVideoJob成功: {"answer":"...","conversation_id":"..."}`

### ステップ5: 最終結果確認（証③）

**期待される動作:**
- 動画送信後、1-3分以内にLINEメッセージが届く

**正常ケース:**
- Difyからの解析結果が届く
- 動画の要約と重要イベントが含まれている

**Dify API 500エラーケース:**
- フォールバックメッセージが届く
- 「Dify APIで一時的なエラーが発生しました。しばらく待ってから再度お試しください。」

---

## 🔍 トラブルシューティング

### 問題1: 受領メッセージが届かない

**確認事項:**
- replyTokenの有効期限（30秒〜1分）
- `lineWebhookRouter`のログを確認
- LINE Webhook URLが正しく設定されているか

**対処方法:**
- ログで`replyToken`と`userId`を確認
- `./reply_now.sh`で即座に返信を試みる

### 問題2: 解析結果が届かない

**確認事項:**
- `processVideoJob`のログを確認
- Dify APIのエラーログを確認
- 署名付きURLが正しく生成されているか

**対処方法:**
- `./check_dify_logs.sh`で詳細ログを確認
- Dify APIのステータスページを確認
- APIキーが正しく設定されているか確認

### 問題3: Dify API 500エラーが続く

**確認事項:**
- 動画URLが署名付きURLになっているか
- 動画ファイルが正しく保存されているか
- Dify APIの障害情報を確認

**対処方法:**
- ログで`Dify APIエラー詳細`を確認
- 動画URLをcurlで直接アクセスして確認
- Difyの公式サポートに問い合わせ

---

## 📊 成功の基準

以下のすべてが確認できれば、完全成功です：

1. ✅ **即時返信:** 送信直後に受領メッセージが届く
2. ✅ **ログ確認:** 署名付きURLが生成されている
3. ✅ **Dify API呼び出し:** リクエストが正常に送信されている
4. ✅ **解析結果:** Difyからの解析結果またはフォールバックメッセージが届く
5. ✅ **エラーなし:** 500エラーが発生しない（またはフォールバックが動作する）

---

## 🎉 期待される動作

**正常な動作フロー:**
1. ユーザーがLINEに動画を送信
2. `lineWebhookRouter`が動画を受信
3. ユーザーに即座に返信（replyToken使用）
4. 動画をCloud Storageに保存（パス: `${userId}/${messageId}.mp4`）
5. 署名付きURLを生成（有効期限: 1時間）
6. `processVideoJob`を呼び出し
7. Dify APIに動画URLを送信
8. Difyが動画を解析
9. 解析結果をLINEに送信

**以前の問題:**
- ❌ パス構造エラー（`videos/`接頭辞）
- ❌ アクセス権限エラー（公開アクセス不可）
- ❌ Dify API 500エラー

**現在の状態:**
- ✅ パス構造がDifyのルールに準拠
- ✅ 署名付きURLでアクセス可能
- ✅ エラーハンドリングとフォールバックが実装済み

---

**最終更新:** 2025-11-08  
**ステータス:** デプロイ完了 ✅ テスト準備完了 ✅

