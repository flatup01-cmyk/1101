rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // video_jobsコレクションのルール
    match /video_jobs/{jobId} {
      // 作成は認証済みユーザーのみ
      allow create: if request.auth != null;

      // 読み取りはジョブの所有者のみ
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // 更新はジョブの所有者のみ、かつ特定のフィールドのみ変更可能
      allow update: if request.auth != null
                      && request.auth.uid == resource.data.userId
                      && request.resource.data.keys().hasOnly(['status', 'analysis_result', 'aika_message', 'notification_sent', 'completed_at', 'updated_at', 'retries', 'error_message']);

      // 削除は拒否（ジョブは削除しない）
      allow delete: if false;
    }

    // video_processingコレクションのルール（冪等性確保用）
    match /video_processing/{docId} {
      // 作成は認証済みユーザーのみ
      allow create: if request.auth != null;

      // 読み取りはジョブの所有者のみ
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // 更新はジョブの所有者のみ、かつ特定のフィールドのみ変更可能
      allow update: if request.auth != null
                      && request.auth.uid == resource.data.userId
                      && request.resource.data.keys().hasOnly(['status', 'file_path', 'user_id', 'started_at', 'updated_at', 'error_message']);

      // 削除は拒否
      allow delete: if false;
    }

    // usersコレクションのルール（会話コンテキスト管理用）
    match /users/{userId} {
      // Cloud Functionsからの書き込みを許可（Admin SDKを使用するため、実際にはルールの影響を受けないが、将来のクライアント側アクセスに備えて設定）
      // 読み取りは認証済みユーザーが自分のデータのみ
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // 書き込みは認証済みユーザーが自分のデータのみ、かつ特定のフィールドのみ変更可能
      allow write: if request.auth != null 
                     && request.auth.uid == userId
                     && request.resource.data.keys().hasOnly(['conversation_id', 'updated_at']);
    }

    // その他のコレクションはデフォルトで拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
