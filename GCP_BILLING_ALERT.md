# 💰 GCP請求アラート設定ガイド

## 📋 目的

予期しない高額請求を防止し、予算を超過する前に通知を受け取ります。

---

## 🎯 ステップ1: GCP Consoleにアクセス

1. [GCP Console](https://console.cloud.google.com/)にアクセス
2. プロジェクト `aikaapp-584fa` を選択
3. 左上のメニュー（☰）→ **「予算とアラート」**

---

## 🎯 ステップ2: 予算を作成

### 2.1 新しい予算を作成

1. **「予算を作成」** をクリック
2. 予算名を入力（例: `aikaapp-monthly-budget`）
3. **予算額を設定:**
   - **推奨:** 5,000円/月（初期）
   - 実際の使用量に応じて調整可能

### 2. 2 予算スコープを設定

- **対象:** 「このプロジェクトのみ」（デフォルト）
- **プロジェクト:** `aikaapp-584fa`

### 2.3 予算期間

- **期間:** 「月次」（デフォルト）
- **開始日:** 今月の1日

---

## 🎯 ステップ3: アラートを設定

### 3.1 アラート設定画面

「アラートを設定」セクションで以下を追加：

| しきい値 | アクション | 推奨 |
|---------|----------|------|
| 50% | メール通知 | ✅ 推奨 |
| 80% | メール通知 | ✅ 推奨 |
| 100% | メール通知 + 予算超過アクション | ✅ 必須 |

### 3.2 予算超過アクション（100%時）

**重要:** 予算超過時にサービスを停止する機能

**設定:**
- 「予算超過時にプロジェクト全体の支出を無効化する」
- ⚠️ **注意:** これを有効にすると、予算超過時に全てのサービスが停止します
- **推奨:** 最初は無効にして、監視期間を設ける

---

## 🎯 ステップ4: 通知先を設定

### 4.1 メール通知

1. **「通知を追加」** をクリック
2. **メールアドレスを入力:**
   - あなたのメールアドレス
   - 複数のアドレスを追加可能
3. **通知ルールを選択:**
   - ✅ 「予算のしきい値に達したとき」
   - ✅ 「予算を超過したとき」

### 4.2 追加通知（オプション）

- **Pub/Sub:** Cloud Functionsで自動処理
- **Slack:** ワークフロー統合
- **Webhook:** カスタム通知

---

## 🎯 ステップ5: 予算を保存

1. 設定を確認
2. **「予算を作成」** をクリック

---

## 📊 追加の監視設定（推奨）

### カスタムメトリクスアラート

異常なAPI使用量を検知：

1. **Cloud Monitoring** → **アラート**
2. **「アラート ポリシーを作成」**
3. **メトリクス:**
   - Cloud Functions 実行回数
   - Storage 読み書き操作数
   - Firestore 読み書き操作数

### 推奨アラート設定

| メトリクス | 条件 | アクション |
|-----------|------|----------|
| Functions実行回数 | 1時間に100回超過 | メール通知 |
| Storage使用量 | 1GB超過 | メール通知 |
| Firestore読み取り | 1日1000回超過 | メール通知 |

---

## 💡 予算額の目安

### 初期設定（開発・テスト環境）

- **月額予算:** 3,000円 - 5,000円
- **アラート:** 50%, 80%, 100%

### 本番環境（ユーザー増加時）

- **月額予算:** 10,000円 - 50,000円（ユーザー数に応じて）
- **アラート:** 50%, 75%, 90%, 100%

---

## 🚨 予算超過時の対応

### 自動停止を有効にしている場合

1. GCPサービスが自動停止
2. 予算を増額または使用量を削減
3. 手動でサービスを再開

### 自動停止を無効にしている場合

1. **即座の対応:**
   - Cloud Functionsの異常実行を確認
   - Storageの異常使用を確認
   - レートリミット設定を確認

2. **緊急対応:**
   - 影響を受けたサービスを一時停止
   - 異常なアクセスパターンを調査

---

## 📈 コスト最適化のヒント

### 1. Cloud Functionsの最適化

- **タイムアウト設定:** 不要に長いタイムアウトを避ける
- **メモリ設定:** 必要最小限のメモリを使用
- **コールドスタート対策:** 継続的なトラフィックでコールドスタートを削減

### 2. Storageの最適化

- **古いファイルの自動削除:** Cloud Functionsで自動削除スクリプトを作成
- **ライフサイクルポリシー:** 30日以上経過したファイルを自動削除

### 3. Firestoreの最適化

- **インデックス最適化:** 不要なインデックスを削除
- **レートリミットデータのクリーンアップ:** 古いレートリミット記録を削除

---

## ✅ チェックリスト

- [ ] 予算を作成（月額上限を設定）
- [ ] 50%アラートを設定
- [ ] 80%アラートを設定
- [ ] 100%アラートを設定
- [ ] 通知先メールアドレスを設定
- [ ] 予算超過アクションを検討（オプション）
- [ ] カスタムメトリクスアラートを設定（オプション）

---

## 🔗 参考リンク

- [GCP 予算とアラート ドキュメント](https://cloud.google.com/billing/docs/how-to/budgets)
- [GCP コスト管理のベストプラクティス](https://cloud.google.com/cost-management/docs/best-practices)

---

**最終更新:** 2025-01-XX
**作成者:** AI Assistant（Auto）

