# 🧪 AIKA18号 バトルスコープ テスト計画書

## 📋 テスト方針

**目標**: 100万回のアップロードで、エラーは1回も許さない「神の信頼性」を実現

**テストカバレッジ**: 
- 正常系: 100%カバー
- 異常系: 100%カバー
- エッジケース: 100%カバー

---

## ✅ 正常系テストシナリオ

### テストケース N-001: 基本的な動画アップロード・解析フロー

**前提条件**:
- ユーザーがLIFFアプリでログイン済み
- 10秒以内、100MB以内の動画ファイルを準備

**実行ステップ**:
1. LIFFアプリで動画を選択
2. 「解析してもいいわよ」ボタンをクリック
3. アップロード進捗を確認
4. 解析完了を待つ
5. LINEメッセージが届くことを確認

**期待結果**:
- ✅ Firestoreにjobドキュメントが作成される（status: 'pending'）
- ✅ Storageに動画がアップロードされる
- ✅ Cloud Functionsがトリガーされる
- ✅ 動画解析が成功する
- ✅ Dify APIからAIKAのセリフが返る
- ✅ LINE APIでユーザーにメッセージが送信される
- ✅ Firestoreが更新される（status: 'completed', notification_sent: true）

**検証項目**:
- [ ] Firestore: `video_jobs/{jobId}` が正しく作成されている
- [ ] Storage: `videos/{userId}/{jobId}/{fileName}` が存在する
- [ ] Cloud Functionsログ: 処理が正常に完了している
- [ ] LINE: ユーザーにメッセージが届いている
- [ ] Firestore: status='completed', notification_sent=true

---

### テストケース N-002: 複数の動画を連続アップロード

**前提条件**:
- レートリミット: 1日10回、1時間3回

**実行ステップ**:
1. 3本の動画を連続でアップロード（1時間以内）

**期待結果**:
- ✅ 最初の3本は正常に処理される
- ✅ 4本目以降はレートリミットエラーになる
- ✅ エラーメッセージがLINEで届く

**検証項目**:
- [ ] 3本まで成功
- [ ] 4本目でレートリミットエラー
- [ ] Firestore: rate_limitsコレクションに記録がある

---

## ⚠️ 異常系テストシナリオ

### テストケース A-001: ファイルサイズ超過（100MB超）

**実行ステップ**:
1. 100MB超の動画ファイルを選択
2. アップロードを試みる

**期待結果**:
- ✅ フロントエンドで即座にエラー表示
- ✅ 「…チッ、100MB以下の動画にしなさいよ」というメッセージ
- ✅ Storageへのアップロードは実行されない

**検証項目**:
- [ ] エラーメッセージが表示される
- [ ] Storageにファイルがアップロードされていない
- [ ] Firestoreにjobドキュメントが作成されていない

---

### テストケース A-002: 動画の長さ超過（10秒超）

**実行ステップ**:
1. 10秒超の動画ファイルを選択
2. アップロードを試みる

**期待結果**:
- ✅ 動画のメタデータ読み込み後にエラー表示
- ✅ 「…長すぎるわよ！10秒以内に収めなさい」というメッセージ
- ✅ Storageへのアップロードは実行されない

**検証項目**:
- [ ] エラーメッセージが表示される（動画の長さが表示される）
- [ ] Storageにファイルがアップロードされていない
- [ ] Firestoreにjobドキュメントが作成されていない

---

### テストケース A-003: 無効な動画ファイル

**実行ステップ**:
1. 動画ファイルではないファイル（.txt等）を選択
2. アップロードを試みる

**期待結果**:
- ✅ ファイル選択時にエラー
- ✅ 「…この動画、読めないわ」というメッセージ

**検証項目**:
- [ ] エラーメッセージが表示される
- [ ] アップロードが開始されない

---

### テストケース A-004: Cloud Functions重複実行

**前提条件**:
- 同じStorageイベントが2回トリガーされる（稀なケース）

**実行ステップ**:
1. 動画をアップロード
2. Cloud Functionsが2回起動される（手動またはテスト環境で再現）

**期待結果**:
- ✅ 1回目のFunction: 正常に処理完了
- ✅ 2回目のFunction: 冪等性チェックでスキップ
- ✅ ユーザーには通知が1回だけ届く

**検証項目**:
- [ ] Firestore: status='processing'を検出してスキップ
- [ ] Cloud Functionsログ: "already processed or processing"と表示
- [ ] LINE: メッセージが1回だけ届く
- [ ] Firestore: notification_sent=trueは1回だけ

---

### テストケース A-005: LINE API送信失敗（ネットワークエラー）

**前提条件**:
- LINE APIが一時的に利用不可（テスト環境でモック）

**実行ステップ**:
1. 正常な動画をアップロード
2. LINE API送信が失敗する（1回目、2回目）
3. 3回目で成功する

**期待結果**:
- ✅ 指数関数的バックオフでリトライ（4秒→8秒）
- ✅ 3回目で成功
- ✅ ユーザーにメッセージが届く
- ✅ Firestore: notification_sent=true

**検証項目**:
- [ ] Cloud Functionsログ: リトライが記録されている
- [ ] 待機時間が指数関数的に増加している
- [ ] 最終的に成功している
- [ ] Firestore: notification_sent=true

---

### テストケース A-006: LINE API送信完全失敗（3回リトライ後も失敗）

**前提条件**:
- LINE APIが完全に利用不可（テスト環境でモック）

**実行ステップ**:
1. 正常な動画をアップロード
2. LINE API送信が3回とも失敗する

**期待結果**:
- ✅ 3回リトライ（4秒→8秒→最大60秒）
- ✅ Cloud LoggingにCRITICALアラートが送信される
- ✅ Firestore: notification_sent=false
- ✅ 管理者に通知が届く

**検証項目**:
- [ ] Cloud Functionsログ: CRITICALアラートが記録されている
- [ ] Firestore: notification_sent=false
- [ ] Cloud Logging: アラートが送信されている
- [ ] 動画解析自体は成功している（Dify APIは成功）

---

### テストケース A-007: Dify API呼び出し失敗

**実行ステップ**:
1. 正常な動画をアップロード
2. Dify APIが失敗する（ネットワークエラー等）

**期待結果**:
- ✅ デフォルトメッセージが使用される
- ✅ LINE API送信は正常に実行される
- ✅ ユーザーにデフォルトメッセージが届く

**検証項目**:
- [ ] Cloud Functionsログ: "Dify APIからメッセージが取得できませんでした"
- [ ] デフォルトメッセージが使用されている
- [ ] LINE: メッセージが届く（デフォルトメッセージ）

---

### テストケース A-008: MediaPipe解析失敗

**実行ステップ**:
1. 破損した動画ファイルまたは解析不可能な動画をアップロード

**期待結果**:
- ✅ Cloud Functionsでエラーをキャッチ
- ✅ Firestore: status='error', error_message='...'
- ✅ ユーザーにエラー通知が送信される

**検証項目**:
- [ ] Firestore: status='error'
- [ ] Firestore: error_messageが記録されている
- [ ] LINE: エラーメッセージが届く
- [ ] 一時ファイルが削除されている

---

### テストケース A-009: Storageダウンロード失敗

**実行ステップ**:
1. Storageからファイルをダウンロードできない状況を再現

**期待結果**:
- ✅ Cloud Functionsでエラーをキャッチ
- ✅ Firestore: status='error', error_message='download failed'
- ✅ ユーザーにエラー通知

**検証項目**:
- [ ] Firestore: status='error'
- [ ] LINE: エラーメッセージが届く

---

## 🔐 セキュリティテストシナリオ

### テストケース S-001: Secret Manager読み込み

**実行ステップ**:
1. Cloud Functionsを起動
2. Secret ManagerからLINEアクセストークンを読み込む

**期待結果**:
- ✅ Secret Managerから正常に読み込まれる
- ✅ フォールバックが動作する（Secret Manager失敗時）

**検証項目**:
- [ ] Cloud Functionsログ: "Secret ManagerからLINEアクセストークンを読み込みました"
- [ ] LINE API送信が正常に動作する

---

### テストケース S-002: パストラバーサル攻撃対策

**実行ステップ**:
1. 不正なパス（`../../etc/passwd`等）でアップロードを試みる

**期待結果**:
- ✅ パス正規化で検出
- ✅ エラー: "invalid path"

**検証項目**:
- [ ] Cloud Functionsログ: "セキュリティ: 不正なパス"
- [ ] アップロードが拒否される

---

### テストケース S-003: 不正なユーザーID

**実行ステップ**:
1. 不正な文字列を含むユーザーIDでアップロードを試みる

**期待結果**:
- ✅ ユーザーID検証で拒否
- ✅ エラー: "invalid user id"

**検証項目**:
- [ ] Cloud Functionsログ: "セキュリティ: 不正なユーザーID"
- [ ] アップロードが拒否される

---

## 🔄 パフォーマンステストシナリオ

### テストケース P-001: 同時アップロード（10ユーザー）

**実行ステップ**:
1. 10人のユーザーが同時に動画をアップロード

**期待結果**:
- ✅ 全員の動画が正常に処理される
- ✅ 冪等性が保証される
- ✅ レートリミットが正しく機能する

**検証項目**:
- [ ] 全10本が正常に処理される
- [ ] Firestore: 全10件のjobが'completed'
- [ ] LINE: 全10人にメッセージが届く

---

### テストケース P-002: 大量アップロード（100件/日）

**実行ステップ**:
1. 100件の動画を1日でアップロード

**期待結果**:
- ✅ 全て正常に処理される
- ✅ エラー率0%

**検証項目**:
- [ ] 処理成功率: 100%
- [ ] エラー数: 0
- [ ] Cloud Functions実行時間: 適切な範囲内

---

## 📊 テスト実行結果レポート形式

```
【テスト実行レポート】

テスト実行日時: YYYY-MM-DD HH:MM:SS
テスト環境: [開発/ステージング/本番]
テスト実行者: [名前]

┌─────────────────┬──────────┬──────────┬─────────┐
│ テストケース    │ 結果     │ 実行時間 │ 備考     │
├─────────────────┼──────────┼──────────┼─────────┤
│ N-001           │ ✅ PASS  │ 30秒     │          │
│ N-002           │ ✅ PASS  │ 5分      │          │
│ A-001           │ ✅ PASS  │ 1秒      │          │
│ A-002           │ ✅ PASS  │ 2秒      │          │
│ ...             │ ...      │ ...      │ ...      │
└─────────────────┴──────────┴──────────┴─────────┘

総合評価: [PASS/FAIL]
エラー率: X%
```

---

## 🎯 テスト自動化

### ユニットテスト

```python
# functions/test_main.py
import unittest
from unittest.mock import Mock, patch
from main import process_video, send_line_message_with_retry

class TestProcessVideo(unittest.TestCase):
    def test_duplicate_processing_idempotency(self):
        """重複実行時の冪等性テスト"""
        # ...
    
    def test_line_api_retry_on_failure(self):
        """LINE API失敗時のリトライテスト"""
        # ...
```

### 統合テスト

```bash
# テストスクリプト例
#!/bin/bash
# test_integration.sh

# 1. 正常系テスト
./test_normal_flow.sh

# 2. 異常系テスト
./test_error_cases.sh

# 3. セキュリティテスト
./test_security.sh
```

---

## ✅ テスト完了基準

**必須条件（全項目達成が必要）**:
- [ ] 正常系テスト: 100% PASS
- [ ] 異常系テスト: 100% PASS
- [ ] セキュリティテスト: 100% PASS
- [ ] パフォーマンステスト: エラー率0%
- [ ] 冪等性テスト: 重複実行で0回の重複通知
- [ ] データ整合性テスト: ゴミデータ0件

**達成基準**:
- エラー率: **0%**（100万回中0回のエラー）
- 処理成功率: **100%**
- 通知成功率: **100%**（リトライ含む）

---

**最終更新**: 2025-01-XX  
**作成者**: AI Assistant (Auto)

